{% extends 'base.html' %} 

{% block content %}


  <h1 id="lerny_name"  class="h3 mb-2 py-3 text-gray-800" align="center">Lerny: PONER NOMBRE DEL LERNY ACA </h1>

  <!-- Page Heading -->
  {% if not have_company %}
  <div class="alert alert-warning alert-dismissible fade show" role="alert">
  <strong>Compañia no encontrada!</strong> Al parecer no tienes una compañia asignada.
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
  </button>
  </div>
  {% endif %}


  <!-- DataTales Example -->
  <div class="card shadow mb-4 table-admin">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-white"  align="center" >Usuarios</h6>
    </div>
  </div>

  <div class="dtsp-verticalContainer">
      <div class="container">
          <table id="dataTable" class="display nowrap" width="100%">
              <thead>
                  <tr>
                      <th>Identificación</th>
                      <th>Usuario</th>
                      <th>Estado</th>
                      <th>Progreso</th>
                  </tr>
              </thead>
          </table>
      </div>
      <!-- <div class="dtsp-verticalPanes col-3"></div> -->
  </div>


  <!-- Content Row -->
  <div align="center">

    <!-- Filtros -->
    <div align="center" class="pt-5 pb-3">
      <select class="form-select" id="lerny_select" aria-label="Default select example">
          <option selected value="-1">Todos los Lerny</option>
      </select>
      <p style="display: none">Microlerny</p>
      <select class="form-select" id="microlerny_select" aria-label="Default select example" style="display: none">
          <option selected value="-1">Todos los Microlerny</option>
      </select>
      <button class="btn btn-dark" type="button" onclick="filter()">FILTRAR</button>
    </div>

    <!-- First Row of Charts -->
    <div class="row" style="padding: 20px">

      <!-- student progress-->
      <div class="col-xl-6 col-lg-4">
    
        <!-- Donut Chart -->
        <div class="card shadow mb-4">
            <!-- Card Header - Dropdown -->
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Progeso estudiantes</h6>
            </div>
            <!-- Card Body -->
            <div class="card-body">
                <div class="chart-bar">
                    <canvas id="myBarChartCant"></canvas>
                </div>
            </div>
        </div>
      </div>

      <!--Students per module -->
      <div class="col-xl-6 col-lg-4">
        <!-- Donut Chart -->
        <div class="card shadow mb-4">
            <!-- Card Header - Dropdown -->
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">% Estudiantes por módulo</h6>
            </div>
            <!-- Card Body -->
            <div class="card-body">
                <div class="chart-bar">
                    <canvas id="myBarChartProgress"></canvas>
                </div>
            </div>
        </div>
    
      </div>

    </div>

    <!-- Second Row of Charts -->
    <div class="row">

      <!-- Average score-->
      <div class="col-xl-6 col-lg-4">
          <!-- Donut Chart -->
          <div class="card shadow mb-4">
              <!-- Card Header - Dropdown -->
              <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary">Puntaje Promedio Módulo</h6>
              </div>
              <!-- Card Body -->
              <div class="card-body">
                  <div class="chart-bar">
                      <canvas id="myBarChartAvg"></canvas>
                  </div>
              </div>
          </div>
      </div>

      <!-- Approved Students -->
      <div class="col-xl-6 col-lg-4">

        <!-- Donut Chart -->
        <div class="card shadow mb-4">

          <!-- Card Header - Dropdown -->
          <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Ususario Aprobados y No Aprobados</h6>
          </div>

          <!-- Card Body -->
          <div class="card-body">
                <div class="chart-bar"><canvas id="myBarChart"></canvas></div>
          </div>

        </div>

      </div>

    </div>


  </div>

  <script type="text/javascript">

    var table = null

    function filter() {
        var lerny_id = $( "#lerny_select" ).children("option:selected").val();
        var microlerny_id = $( "#microlerny_select" ).children("option:selected").val();

        table.ajax.url( '/api_lerny/lernydetail/?lerny_id=' + lerny_id +'&microlerny_id=' + microlerny_id).load();
        myBarChart.destroy();
        myBarChartCant.destroy();
        myBarChartProgress.destroy();
        myBarChartAvg.destroy();

        $.ajax({
          method: 'GET',
          url: '/api_lerny/lernydetail/?lerny_id=' + lerny_id +'&microlerny_id=' + microlerny_id,
          success: function(respuesta) {
            var data_pie = respuesta.approved;
            var data_micro = respuesta.info_micro;
            var name_micro = respuesta.name_micro;
            var cont_micro = respuesta.cont_micro;
            var progress_micro = respuesta.progress_micro;
            var average = respuesta.average_micro;

             //Approved Students chart
            var ctx = document.getElementById("myBarChart");
            myBarChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ["Aprobado", "No Aprobado"],
                datasets: [{
                  label: "Porcentaje",
                  data: data_pie,
                  backgroundColor: ['#4e73df', '#BB86FC'],
                  hoverBackgroundColor: ['#2e59d9', '#BB86FC'],
                  borderColor: "#4e73df",
              }],
          },
          options: {
            maintainAspectRatio: false,
            tooltips: {
              backgroundColor: "rgb(255,255,255)",
              bodyFontColor: "#858796",
              borderColor: '#dddfeb',
              borderWidth: 1,
              xPadding: 15,
              yPadding: 15,
              displayColors: true,
              caretPadding: 10,
          },
          legend: {
              display: false
          },
            scales: {
              xAxes: [{
                gridLines: {
                  display: false,
                  drawBorder: false
                },
                ticks: {
                  maxTicksLimit: 6
                },
                maxBarThickness: 25,
              }],
              yAxes: [{
                ticks: {
                  min: 0,
                  max: 100,
                  maxTicksLimit: 5,
                  padding: 10,
                  // Include a dollar sign in the ticks
                },
                gridLines: {
                  color: "rgb(234, 236, 244)",
                  zeroLineColor: "rgb(234, 236, 244)",
                  drawBorder: false,
                  borderDash: [2],
                  zeroLineBorderDash: [2]
                }
              }],
            },
      },
  });

            // student progress chart
            var ctx = document.getElementById("myBarChartCant");
            myBarChartCant = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: name_micro,
              datasets: [{
                label: "# Estudiantes",
                data: cont_micro,
                hoverBackgroundColor: ['#00A3EF'],
                borderColor: "#E0F4FF",
              }],
            },
            options: {
              maintainAspectRatio: false,
              tooltips: {
                backgroundColor: "#FFFFFF",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: true,
                caretPadding: 10,
              },
              legend: {
                display: false
              },
              scales: {
                xAxes: [{
                  gridLines: {
                    display: false,
                    drawBorder: false
                  },
                  ticks: {
                    maxTicksLimit: 6
                  },
                  maxBarThickness: 25,
                }],
                yAxes: [{
                  ticks: {
                    maxTicksLimit: 5,
                    padding: 10,
                  },
                  gridLines: {
                    color: "#000",
                    zeroLineColor: "#8551F4",
                    drawBorder: false,
                    borderDash: [2],
                    zeroLineBorderDash: [2]
                  }
                }],
              },
            },
          });

            //Students per module chart
            var ctx = document.getElementById("myBarChartProgress");
            myBarChartProgress = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: name_micro,
                datasets: [{
                  label: "Progreso",
                  data: progress_micro,
                  hoverBackgroundColor: ['#2e59d9'],
                  borderColor: "#4e73df",
                }],
              },
              options: {
                maintainAspectRatio: false,
                tooltips: {
                  backgroundColor: "rgb(255,255,255)",
                  bodyFontColor: "#858796",
                  borderColor: '#dddfeb',
                  borderWidth: 1,
                  xPadding: 15,
                  yPadding: 15,
                  displayColors: true,
                  caretPadding: 10,
                },
                legend: {
                  display: false
                },
                scales: {
                  xAxes: [{
                    gridLines: {
                      display: false,
                      drawBorder: false
                    },
                    ticks: {
                      maxTicksLimit: 6
                    },
                    maxBarThickness: 25,
                  }],
                  yAxes: [{
                    ticks: {
                      maxTicksLimit: 5,
                      padding: 10,
                    },
                    gridLines: {
                      color: "rgb(234, 236, 244)",
                      zeroLineColor: "rgb(234, 236, 244)",
                      drawBorder: false,
                      borderDash: [2],
                      zeroLineBorderDash: [2]
                    }
                  }],
                },
              },
            });
            
            //Average score chart
            var ctx = document.getElementById("myBarChartAvg");
            myBarChartAvg = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: name_micro,
              datasets: [{
                label: "Promedio",
                data: average,
                hoverBackgroundColor: ['#2e59d9'],
                borderColor: "#4e73df",
              }],
            },
            options: {
              maintainAspectRatio: false,
              tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: true,
                caretPadding: 10,
              },
              legend: {
                display: false
              },
              scales: {
                xAxes: [{
                  gridLines: {
                    display: false,
                    drawBorder: false
                  },
                  ticks: {
                    maxTicksLimit: 6
                  },
                  maxBarThickness: 25,
                }],
                yAxes: [{
                  ticks: {
                    maxTicksLimit: 5,
                    padding: 10,
                  },
                  gridLines: {
                    color: "rgb(234, 236, 244)",
                    zeroLineColor: "rgb(234, 236, 244)",
                    drawBorder: false,
                    borderDash: [2],
                    zeroLineBorderDash: [2]
                  }
                }],
              },
            },
          });
},
    error: function() {
            console.log("No se ha podido obtener la información");
        }
    });

    }

    $( "#lerny_select" ).change(function() {
        $( "#lerny_name" ).text($( "#lerny_select" ).children("option:selected").text())
        $( "#microlerny_select" ).show()
        $('#microlerny_select').children().remove().end()
        .append('<option selected value="-1">Todos los Microlerny</option>') ;
        var lerny_id = $( "#lerny_select" ).children("option:selected").val();
        $.ajax({
            method: 'POST',
            url: '/api_lerny/microlernyapi/',
            data: { pk: lerny_id },
            success: function(data) {
                for(var i = 0; i < Object.keys(data).length; i++) {
                    document.getElementById("microlerny_select").innerHTML += "<option value='"+data[i].pk+"'>"+data[i].name+"</option>";
                }
            },
            error: function() {
                console.log("No se ha podido obtener la información");
            }
        });
    });

    $(document).ready(function() {

        table = $('#dataTable').DataTable( {
            ajax: {
                url: '/api_lerny/lernydetail/?lerny_id=-1&microlerny_id=-1',
                type: 'GET',
                dataType: 'json'
            },
            columns :[
            {data: 'identification'},
            {data: 'user'},
            {data: 'done'},
            {data: 'progress'},

            ],
            searchPanes: {
                layout: 'columns-1',
                columns: [0,1,2]
            },
            dom: '<"dtsp-dataTable"frtip>',
            pageLength: 20
        })

        table.searchPanes();
        $("div.dtsp-verticalPanes").append(table.searchPanes.container());
    })

    $.ajax({
        url: '/api_lerny/lernyapi/',
        success: function(data) {
            for(var i = 0; i < Object.keys(data).length; i++) {
                document.getElementById("lerny_select").innerHTML += "<option value='"+data[i].pk+"'>"+data[i].name+"</option>";
            }

            $( "#lerny_name" ).text(data[0].name)
        },
        error: function() {
            console.log("No se ha podido obtener la información");
        }
    });

</script>




{% endblock %}